---
layout: post
title:  "Setup LDAP Server on CentOS/RHEL"
author: Yandong Yao
date:   2016-06-28 11:49
categories: ldap rhel
published: true
---

# Install and Setup LDAP server

## Install LDAP 

Remove old LDAP data if exists:

	$ sudo rm -rf /etc/openldap/*
	$ sudo rm -rf /var/lib/openldap/openldap-data/*

Install LDAP packages and start slapd daemon

	$ sudo yum -y install openldap openldap-servers openldap-clients
	$ sudo chkconfig slapd on
	$ sudo service slapd start

## Setup LDAP

To use LDAP, firstly, need to use `ldapmodify` to change ldap setting,
especially olcSuffix, olcRootDN, olcRootPW.

olcRootDN need consistent with olcSuffix, otherwise, ldap server will report
error: <olcRootPW> can only be set when rootdn is under suffix


### LDAP config file

old openldap use slapd.conf, new version use 'cn=config' format.

By default, the OpenLDAP server uses Berkeley DB (BDB) as a database back end. The configuration for this database is stored in the /etc/openldap/slapd.d/cn=config/olcDatabase={2}bdb.ldif file. The following directives are commonly used in a database-specific configuration:

	* olcSuffix, olcRootDN, olcRootPW

### Change olcSuffix, olcRootDN, olcRootPW

passwd is generated by slappasswd.

    sudo ldapmodify -Q -Y EXTERNAL -H ldapi:/// << E0F
    dn: olcDatabase={2}bdb,cn=config
    changetype: modify
    add: olcRootPW
    olcRootPW: {SSHA}COv+qkZWonJbH7o3vi4tvp476rBj9Fx1
    E0F

    sudo ldapmodify -Q -Y EXTERNAL -H ldapi:/// << E0F
    dn: olcDatabase={2}bdb,cn=config
    changetype: modify
    replace: olcRootDN
    olcRootDN: cn=admin,dc=pivotal,dc=io
    E0F

    sudo ldapmodify -Q -Y EXTERNAL -H ldapi:/// << E0F
    dn: olcDatabase={2}bdb,cn=config
    changetype: modify
    replace: olcSuffix
    olcSuffix: dc=pivotal,dc=io
    E0F

## Load data into LDAP database

normally use ldif format file to load data.

following example.ldif will create two ou (People, Groups) and rootdn: gpadmin


	$ cat example.ldif
	dn: dc=pivotal,dc=io
	objectclass: dcObject
	objectclass: organization
	o: Example Org
	dc: pivotal

	dn: ou=People,dc=pivotal,dc=io
	objectClass: organizationalUnit
	objectClass: top
	ou: People

	dn: ou=Groups,dc=pivotal,dc=io
	objectClass: organizationalUnit
	objectClass: top
	ou: Groups

	dn: cn=gpadmin,dc=pivotal,dc=io
	objectclass: organizationalRole
	cn: gpadmin


	$ ldapadd -vvv -x -D "cn=admin,dc=pivotal,dc=io" -w changeme -f example.ldif

	$ ldapsearch -x -b 'dc=pivotal,dc=io' '(objectclass=*)'

## Load user account information

    [gpadmin@test1 ldap]$ cat user.ldif
    dn: uid=plainuser,dc=pivotal,dc=io
    objectclass: top
    objectclass: person
    objectclass: inetOrgPerson
    uid: plainuser
    cn: plainuser
    sn: plainuser

    dn: uid=tlsuser,dc=pivotal,dc=io
    objectclass: top
    objectclass: person
    objectclass: inetOrgPerson
    uid: tlsuser
    cn: tlsuser
    sn: tlsuser

    dn: uid=ldapsuser,dc=pivotal,dc=io
    objectclass: top
    objectclass: person
    objectclass: inetOrgPerson
    uid: ldapsuser
    cn: ldapsuser
    sn: ldapsuser		 

Load user account into LDAP server.

    $ ldapadd -vvv -x -D "cn=admin,dc=pivotal,dc=io" -w changeme -f user.ldif

Setup user's password

    $ ldappasswd -S -x -D "cn=admin,dc=pivotal,dc=io" -w changeme uid=plainuser,dc=pivotal,dc=io -s changeme
    $ ldappasswd -S -x -D "cn=admin,dc=pivotal,dc=io" -w changeme uid=tlsuser,dc=pivotal,dc=io -s changeme
    $ ldappasswd -S -x -D "cn=admin,dc=pivotal,dc=io" -w changeme uid=ldapsuser,dc=pivotal,dc=io -s changeme

Verify works using normal user credential:

    $ ldapsearch -x -h localhost -D "uid=plainuser,dc=pivotal,dc=io" -w changeme -b "dc=pivotal,dc=io" cn
