---
layout: post
title:  "如何执行 GPDB 测试"
author: 姚延栋
date:   2015-11-10 11:20:43
categories: GPDB test
---

### 如何执行 GPDB 的测试

#### 基本步骤

在运行这些测试前，需要启动 GPDB，并且 export PGPORT和MASTER_DATA_DIRECTORY 两个环境变量

    -bash-4.1$ echo $MASTER_DATA_DIRECTORY
    /home/gpadmin/data/gpdb.master/master/gpseg-1
    -bash-4.1$ echo $PGPORT
    5432

运行测试

    $ cd $topdir
    $ make installcheck-good

或者直接进入测试代码目录

    $ cd $topdir/src/test
    $ make installcheck-good

installcheck-good 目标会进入 src/test 并执行相应的测试，而该目录下得 Makefile 直接调用 `$(MAKE) -C regress $@`

    check installcheck installcheck-parallel installcheck-good:
            $(MAKE) -C src/test $@

src/test/Makefile. 使用了 .DEFAULT 目标。

    .DEFAULT:
    	$(MAKE) -C regress $@

#### installcheck-good 测试内容

installcheck-good 调用 pg_regress 执行2个schedule：

* parallel_schedule: 包含 PostgreSQL 社区的测试用例，和 GPDB 有冲突的测试被 disable 了。
* greenplum_schedule： 包含 GPDB 的测试用例


#### 运行单个测试

     // make installcheck-good TT=float4 由于 f18c7e45f683924112d9ebdfef748557be3d8ac2，这种方式不行了。
     ./pg_regress <testname>

例如

    ./pg_regress custom_format

对于 bugbuster 测试：

    ./pg_regress --inputdir=bugbuster  --outputdir=bugbuster <testname>


### pg_regress 介绍

pg_regress 是 GPDB 回归测试驱动程序。它会根据一定的规则运行特定目录里面的 SQL 脚本，并将测试结果和期望的结果进行比较。

#### 基本原理

默认运行 sql 目录下得脚本文件（根据名字可以运行指定脚本），将结果保存到 resuls/*.out 下面，并和 expected/*.out 进行比较。

#### 模板支持

如果 SQL 脚本中需要使用某些变量、占位符，譬如 SQL 和主机名或者某些目录相关，则可以使用类似模板的技术。

在 input 目录下得 sql 脚本可以包含例如 @var@ 的变量， pg_regress 执行时，会动态生成 sql 脚本，并运行。

### GPDB enhancement

GPDB 提供了几个 perl 脚本以执行某些处理，这些脚本默认位于 src/test/regress 目录下。 运行这个目录下的测试程序没有问题，
但是如果在其他目录下，譬如 extension/gpfdist，如果需要执行模板中的变量替换，会报告找不到 gpstringsub.pl 脚本的错误。

有几个主要的目录：

* inputdir: 默认是当前目录
* outputdir： 默认是当前目录
* srcdir: 源代码目录的绝对路径 （用于 VPATH 编译）
* temp-install： 临时安装目录
* bindir: 这个变量很重要，它来自于 pg_config_paths.h 和 Makefile。 如果找不到正确的路径，多半是 ./configure --prefix=/path 设置错了。